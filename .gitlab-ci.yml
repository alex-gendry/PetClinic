stages:
  - static

variables:
  DOCKER_REGISTRY: docker.ekseed.org

scan:
  stage: static
  image: docker.ekseed.org/sast-client:22.2.0-linux
  variables:
    PACKAGE_FOLDER: package
  script:
    # FCLI FOD LOGIN
    - fcli fod session login --url $FOD_API_URL --tenant $FOD_TENANT -u $FOD_USERNAME -p $FOD_PAT

    # Create Application Release
    - fcli fod release create "${CI_PROJECT_TITLE} [AG]":$CI_COMMIT_BRANCH --status Production --skip-if-exists --store release

    # Package Creation
    - mvn dependency:tree -DoutputFile=$PACKAGE_FOLDER/.debricked-maven-dependencies.tgf -DoutputType=tgf
    - mvn package -DskipTests
    - mvn dependency:copy-dependencies -DoutputDirectory=$PACKAGE_FOLDER/lib
    - cp src $PACKAGE_FOLDER/src
    - cp target/site/jacoco/* $PACKAGE_FOLDER/src/site
    - cp target/classes $PACKAGE_FOLDER/lib/classes
    - cp target/petclinic.war $PACKAGE_FOLDER/petclinic.war
    - cd $PACKAGE_FOLDER
    - scancentral package -bt none -targs "-cp lib" -o package.zip

    # Upload
    - fcli fod sast setup "$CI_PROJECT_TITLE":$CI_COMMIT_BRANCH --assessment Static --frequency Subscription --audit-preference Automated --technology-stack JAVA/J2EE/Kotlin --language-level 1.8 --oss --store sast_config
    - fcli fod sast start "$CI_PROJECT_TITLE":$CI_COMMIT_BRANCH --purchase-entitlement  --in-progress Queue -f package.zip --store '?'
    - fcli fod sast wait-for '?'  -i 30s

  artifacts:
    paths:
      - $PACKAGE_FOLDER/package.zip
  tags:
    - docker-exec
    - linux
