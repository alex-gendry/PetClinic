stages:
  - scan
  - upload
  - docker_push
  - docker_rm

variables:
  DOCKER_REGISTRY: docker.ekseed.org
  IMAGE_NAME: ${CI_PROJECT_NAME}
  FTFY_PROJECT: "BodgeIt"
  FTFY_BUILD: "$FTFY_PROJECT-$CI_COMMIT_BRANCH"
  FTFY_FPR_FILE: "$CI_COMMIT_SHORT_SHA-gitlab_com-$FTFY_BUILD.fpr"
  FTFY_SSC_URL: "https://ssc.ekseed.org/ssc"


SAST-scan:
  stage: scan
  script:
    - sourceanalyzer -verbose -b $FTFY_BUILD -clean
    - ./mvnw package
    - sourceanalyzer -verbose -b $FTFY_BUILD target
    - sourceanalyzer -verbose -b $FTFY_BUILD -show-files
    - sourceanalyzer -verbose -b $FTFY_BUILD -scan -f $FTFY_FPR_FILE
  artifacts:
    name: FPR_FILE
    paths:
      - $FTFY_FPR_FILE
  tags:
    - fortify-ubuntu


SAST-upload:
  stage: upload
  dependencies:
    - SAST-scan
  script:
    - fortifyclient -debug -url $FTFY_SSC_URL -authtoken $FTFY_CI_TOKEN uploadFPR -application $FTFY_PROJECT -applicationVersion $CI_COMMIT_BRANCH -file $FTFY_FPR_FILE
  tags:
    - fortify-ubuntu
